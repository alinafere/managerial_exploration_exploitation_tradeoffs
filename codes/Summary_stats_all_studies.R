## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021
# Analysis for Study 1

## Change flags for MODEL, DATA, INDDIFF, K (for EE/EWA)
## discount r, model_code

## Load required packages ----
rm(list=ls())
library(tidyverse)
library(magrittr)
library(Hmisc)
library(gridExtra)

## Set paths ----
PATH_FUNCTION= "/set/local/path/here" 
PATH_DATA="/set/local/path/here"
PATH_RESULTS="/set/local/path/here"
PATH_PLOTS='set/your/path/here'

## Source functions ----
source(paste(PATH_FUNCTION,"/EEtradeoffs_functions.R", sep="") ) 

## Summary stats of Study 1----
## Load data ----
roundsData=read_csv(paste(PATH_DATA, "/businessTask_Study1.csv", sep="") ) 
psychData=read_csv(paste(PATH_DATA, "/psychVars_Study1.csv", sep="") ) 

roundsData=roundsData %>% 
  mutate(Rounds=rounds+1) %>% 
  group_by(userid) %>% 
  mutate(ID = cur_group_id(),
         lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup() %>% 
  arrange(ID, Rounds)

H=length(unique(roundsData$userid))
N_arms= 3
prior=50
K=3
D=2
N0=1

## random effects
inddif=psychData %>% #filter(id %in% 1:10) %>% 
  mutate(iota=rep(1, H), RA=log(crra))%>%
  select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (j in 2:ncol(indcen))
  indcen[,j]=indcen[ ,j]-mean(indcen[ ,j])
head(indcen)

u=indcen
u=as.matrix(indcen[,1])

Nobs=max(roundsData$Rounds)

#* compute Gain-Loss dummy variable ----
roundsData_withGL=roundsData %>% group_by(userid) %>% 
  mutate(lagX=lag(results) ) %>% 
  mutate(lagX=replace(lagX, is.na(lagX), 50)) %>% 
  mutate(Xmean=cumsum(lagX)/Rounds) %>% 
  mutate(leadGL=ifelse(results<Xmean, 1, 0)) %>% 
  mutate(GL=lag(leadGL)) %>% 
  mutate(GL=replace(GL, is.na(GL), 0)) %>% 
  ungroup()

### SUMMARY STATS RAW DATA ----
#* switching data and plots ----
switchingdata=roundsData_withGL %>% mutate(choice_bestalt=ifelse(picks==1, 1, 0)) %>% 
  group_by(userid) %>% 
  mutate(lag_picks=lag(picks, 1, 0)) %>% 
  mutate(switches=ifelse(picks==lag_picks, 0, 1)) %>% 
  ungroup()

## corr switching and rewards
switchingdata=switchingdata %>% 
  mutate(lagX=lag(results,1, prior[1])) 
## split between early (rounds 1-50) and late (rounds 51-100)
a= glm(as.factor(switches) ~ lagX, data = switchingdata %>%
                   filter(Rounds %in% 51:100), family = "binomial")
summary(a)

## plot figure 2 Proportion of participants switching to a different arm in each round
prswitches=switchingdata %>% group_by(Rounds) %>% 
  summarise(pr_switches=sum(switches)/H, pr_bestalt=sum(choice_bestalt)/H)

switchers_plot=prswitches %>% filter(Rounds!=1) %>% ggplot(aes(x=Rounds, y=pr_switches*100))+ 
  geom_point()+stat_smooth(method = 'lm', formula = y ~ poly(x,2), color="black")+
  scale_y_continuous(name="Percentage switches", lim=c(0,100))+
  labs(x="Rounds")+
  theme_light()+theme(legend.position="bottom")
switchers_plot
plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/switchers_plot.pdf') )

### switchers at various levels of rewards
## plot Figure 4 Proportion of participants switching to a different arm across the distribution of previous rewards
prswitch_rewards=switchingdata %>%
  mutate(split=ifelse(Rounds<51, "First 50 Rounds", "Last 50 Rounds")) %>% 
  filter(Rounds %in% 2:100) %>% 
  group_by(lagX, split) %>% 
  summarise(pr_switches=sum(switches)/n(), count=n())

switchers_reward_plot=prswitch_rewards %>% ggplot(aes(x=lagX, y=pr_switches*100))+ 
  geom_point()+stat_smooth( color="black")+
  scale_y_continuous(name="Percentage switches", lim=c(0,100))+
  labs(x="Rewards")+
  facet_wrap(~split)+
  theme_light()+theme(legend.position="bottom")
switchers_reward_plot
plot_scale <- 3
plot_aspect <- 2
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS,'/switchers_rewards_plot.pdf') )

### choice of the best alternative
## plot Figure 3 Proportion of participants choosing the arm with highest reward, in each round
plot_bestalt=prswitches %>% filter(Rounds!=1) %>% ggplot(aes(x=Rounds, y=pr_bestalt*100))+ 
  geom_point()+stat_smooth(method = 'lm', formula = y ~ poly(x,2), color="black")+
  scale_y_continuous(name="Percentage choices of high-performing arm", lim=c(0,100))+
  labs(x="Round")+
  theme_light()+theme(legend.position="bottom")
plot_bestalt
roundsData %>% group_by(userid) %>% summarise(a=mean(A), b=mean(B), cc=mean(C))
head(roundsData)

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/plot_bestalt.pdf')  )

## cor rewards and time spent and number of switches
RTS= switchingdata %>% 
  group_by(userid) %>% 
  summarise(sumSwitch=sum(switches),sumTime=sum(time_spent),TotRewards=sum(results))
rcorr(as.matrix(RTS %>% select(-userid)))

## spent less than half a second per round
nrow(switchingdata %>% filter(time_spent<0.5))/nrow(switchingdata)
nrow(switchingdata %>% 
       filter(time_spent<0.5) %>% 
       filter(picks==lag_picks))/ nrow(switchingdata %>% filter(time_spent<0.5))

#* Time analysis----
### correlation time spend per rounds and lagged rewards 
rcorr(as.matrix(switchingdata %>% dplyr::select(time_spent, lagX)), type="spearman")
roundsData %>% filter(Rounds<11) %>% summarise(a=mean(time_spent))

timeData %>% ggplot(aes(x=as.factor(gl), y=time_spent, fill=as.factor(gl)))+geom_boxplot()

## Plot time spent & choices (Figure 5) ----
## choose subjects
temp=c(4, 3,46)
### build two separate plots
p1=roundsData %>% filter(userid %in% temp) %>%
  ggplot(aes(x=rounds, y=picks-4))+
  geom_point(aes(shape=as.factor(picks)))+
  scale_y_continuous(name="Choice of arm", breaks=c(-3, -2, -1), labels= c("1", "2", "3"))+
  labs(x="", shape="Choice of arm")+
  theme_light()+theme(legend.position="none")
p1=p1+facet_wrap(~userid, ncol=3, labeller = as_labeller( c("4"="Subject 4", "3"="Subject 3", "46"="Subject 46")))
p1                                                           

p2 <-roundsData %>% filter(userid %in% temp) %>%
  ggplot(aes(x=rounds, y=time_spent))+
  geom_line(size=.8)+
  labs(x="Rounds", y="Time spent (in seconds)")+theme_light()+
  theme(legend.position = "bottom")+
  facet_wrap( ~ userid, ncol=3)+  
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )
p2
## bind plots
a=grid.arrange(p1, p2, ncol=1)

plot_scale <- 4
plot_aspect <- 2.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot('time_and_choices.pdf') 


## Summary stats for Study 2 ##########
##* Load data ----
roundsData_2sims=read_csv(paste(PATH_DATA, "/roundsData_xtreme2.csv",  sep=""))  
psychVars=read_csv(paste(PATH_DATA, "/psychVars_xtreme2.csv",  sep=""))

roundsData_2sims %<>% 
  ## for this usercode, we didn't have any data from the website
  filter(usercode!="2RM6E4RVD") %>% 
  arrange(usercode, Business_sim, Rounds)%>% 
  #mutate(ID = group_indices(., usercode))
group_by(usercode) %>%
mutate(ID = cur_group_id()) %>%
ungroup()

psychVars %<>% 
  mutate(usercode=gsub("X", "", usercode) ) %>% 
  ## for this usercode, we didn't have any data from the website
  filter(usercode!="2RM6E4RVD")%>% 
  arrange(usercode) %>% 
  #mutate(ID = group_indices(., usercode))
  group_by(usercode) %>%
  mutate(ID = cur_group_id())  %>%
  ungroup()

#** Switching behavior and choice of best alternative ----
prior=50
## amount of switching (section WA1.2.2)
switchingdata=roundsData_2sims %>% mutate(choice_bestalt=ifelse(picks==1, 1, 0)) %>% 
  group_by(usercode, Business_sim) %>% 
  mutate(lag_picks=lag(picks, 1, default=0)) %>% 
  mutate(switches=ifelse(picks==lag_picks, 0, 1)) %>% 
  ungroup() 

### switching and rewards
switchingdata=switchingdata %>% 
  mutate(lagX=lag(results,1, prior)) 

a=mylogit <- glm(as.factor(switches) ~ lagX+Business_sim+lagX*Business_sim, data = switchingdata %>%
                   filter(Rounds!=1), family = "binomial")
summary(a)

N=nrow(roundsData_2sims)       # number of observations
H=length(unique(roundsData_2sims$ID))            # number of indivIDuals

prswitches=switchingdata %>% group_by(Rounds, Business_sim) %>% 
  summarise(pr_switches=sum(switches)/H, pr_bestalt=sum(choice_bestalt)/H) %>% 
  ungroup()

### switchers at various levels of rewards
prswitch_bsim=switchingdata %>% 
  group_by(usercode, Business_sim) %>% 
  summarise(pr_switches=mean(switches) ) %>% 
  ungroup()

prswitch_bsim %>% #filter(Rounds %in% 91:100) %>% 
  group_by(Business_sim) %>% 
  summarise(meanpr_switches=mean(pr_switches))

t.test(pr_switches~Business_sim, data=prswitch_bsim, paired=T)

## pr best alt first and last 10 rounds
switchingdata %>% 
  filter(Business_sim=="business_sim_2") %>% 
  filter(Rounds %in% 91:100) %>%
  summarise(pra=sum(choice_bestalt)/(H*10))

## Summary stats for Study 3 #########################
#* Load data ----
roundsData_xtreme3=read_csv(paste(PATH_DATA, "/roundsData_xtreme3.csv",  sep=""))  
psychVars=read_csv(paste(PATH_DATA, "/psychVars_xtreme3.csv",  sep=""))

roundsData_xtreme3 %<>% 
  mutate(usercode=gsub("X", "", usercode) )
psychVars %<>% 
  mutate(usercode=gsub("X", "", usercode) )
roundsData_xtreme3 %<>% arrange(usercode, Rounds) 
psychVars %<>% arrange(usercode)

roundsData_xtreme3=roundsData_xtreme3 %>% 
  filter(usercode %in% psychVars$usercode)
length(unique(roundsData_xtreme3$usercode))
psychVars=psychVars %>% 
  filter(usercode %in% roundsData_xtreme3$usercode)
length(unique(psychVars$usercode))

roundsData = roundsData_xtreme3 %>%  
  group_by(usercode) %>% 
  mutate(condition=rep(last(Rounds), n()),
         lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup()

## number of subjects per condition
roundsData %>% group_by(condition) %>% 
  summarise(a=length(unique(usercode)))

## switching behavior 
prior=50
switchingdata_xtreme3=roundsData %>% 
  group_by(usercode, condition) %>%
  mutate(lag_picks=lag(picks, 1, NA), 
         lagX=lag(results, 1, prior)) %>% 
  ungroup() %>% 
  mutate(switches=ifelse(picks==lag_picks, 0, 1)) %>% 
  mutate(c20=ifelse(condition==20, 1,0),
         c50=ifelse(condition==50, 1,0),
         c100=ifelse(condition==100, 1,0),
         c200=ifelse(condition==200, 1,0))

##* Percentage choice of the best option in first vs. last 10 rounds ----
pr_explore=switchingdata_xtreme3 %>% 
  group_by(usercode) %>% 
  #slice_head(n=10) %>%
  slice_tail(n=10) %>%
  ungroup() %>% 
  group_by(condition) %>% 
  summarise(condition=mean(condition), 
            meanpr_switches=length(picks[picks==1])/n())
pr_explore

#*Switching behavior ----
prswitches %>% 
  group_by(Business_sim) %>% 
  summarise(meanpr_bestalt=mean(pr_bestalt))

a=mylogit <- glm(as.factor(switches) ~ lagX + c20+c50+c100 + c20*lagX+c50*lagX+c100*lagX, data = switchingdata_xtreme3 %>%
                   filter(Rounds!=1), family = "binomial")
summary(a)

## Plots of EWA model ----
##* Web appendix WA5 ----
N0=1
Nrd=50
prior=rep(50, Nrd)
X=seq(26, 75, 1)
condition=c("1",#"rho = 0, phi < 1 - CR",
            "2",#"rho = phi < 1 - AR",
            "3",#"rho < phi < 1 ",
            "4") #"phi < rho < 1 ")

rho=c(0, .8, .6, .8)
phi=c(.8, .8, .8, .6)
lambda=c(0, .05, .2, 1)
ewa_df=NULL

for (j in 1:length(condition)){
  Decay=data.frame(Decay=rep(condition[j], Nrd))
  ewa_probs=matrix( , nrow=Nrd, ncol=length(lambda))
  ew=W_Average=W_prior=rep(0, Nrd)
  
  ew[1]=N0
  W_Average[1]=X[1]
  W_prior[1]=prior[1]
  
  for (i in 1:length(lambda))
    ewa_probs[1, i]=softmax(c(lambda[i]*W_Average[1], lambda[i]*W_prior[1]))[1]
  
  for (t in 2:Nrd){
    ## upate still based on actual choices
    ew1=ew[t-1];
    ew[t]=rho[j]*ew[t-1]+1;
    W_Average[t]=(phi[j]*ew1*W_Average[t-1]+X[t])/ew[t];
    W_prior[t]=  (phi[j]*ew1*W_prior[t-1]+prior[t])/ew[t];
    
    ## compute choice probability
    for (i in 1:length(lambda))
      ewa_probs[t, i]=softmax(c(lambda[i]*W_Average[t], lambda[i]*W_prior[t]))[1]
  }
  
  colnames(ewa_probs)=c("lambda0", "lambda.05", "lambda.2", "lambda1")
  
  ewa_df=ewa_df %>% 
    bind_rows(data.frame(ewa_probs) %>% 
                bind_cols(data.frame(Decay=Decay, Round=1:Nrd, W_Average=W_Average, W_prior=W_prior)) %>% 
                pivot_longer(-c(Decay, Round, W_Average, W_prior), names_to = "Sensitivity", values_to="Choice_prob"))
  
}

label_swap <- get_label_swap(Decay=list("1"=expression(paste(rho," = 0, ",phi," < 1 - CR")),
                                        "2"=expression(paste(rho," = ",phi," < 1 - AR")),
                                        "3"=expression(paste(rho," < ",phi," < 1 ")),
                                        "4"=expression(paste(phi," < ",rho," < 1 "))))
ewa_df$Sensitivity =factor(ewa_df$Sensitivity, 
                           levels = c("lambda0", "lambda.05", "lambda.2", "lambda1"))

ewa_prob_simple=ewa_df %>% 
  filter(Decay=="2") %>% 
  ggplot(aes(x=Round, y=Choice_prob, linetype=Sensitivity))+
  geom_line(size=1)+
  labs(y='Choice probability', fill="Decay")+
  scale_linetype_manual(values = c(3, 4, 2, 1), labels=c(expression(paste(lambda," = 0")), expression(paste(lambda," = .05")), expression(paste(lambda," = .2")), expression(paste(lambda,"= 1"))))+
  theme_light()+theme(legend.position = "right") 

ewa_prob_simple
plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
setwd(PATH_PLOTS)
save_plot('ewa_prob_simple.pdf')


ewa_wa_plot=ewa_df %>% 
  filter(Sensitivity=="lambda1") %>% dplyr::select(-Choice_prob) %>% 
  pivot_longer(-c(Decay, Round, Sensitivity), names_to = "Arm", values_to = "WA") %>% 
  ggplot(aes(x=Round, y=WA, color=Arm))+
  geom_line(size=1)+
  facet_wrap(~Decay, ncol=4, labeller = label_swap)+
  labs(y='Attraction')+
  scale_color_manual(values=c("gray60", "black"), labels=c("Risky", "Safe"))+
  theme_light()+theme(legend.position = "bottom") 
ewa_wa_plot


plot_scale <- 3
plot_aspect <- 2.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'ewa_wa_facets.pdf') )
