## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021
# Analysis for Study 1

## Load required packages ----
rm(list=ls())
library(tidyverse)
library(magrittr)
library(rstan)
library(loo)
library(nnet)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

## Set paths ----
PATH_FUNCTION= "/set/local/path/here" 
PATH_DATA="/set/local/path/here"
PATH_RESULTS="/set/local/path/here"
PATH_PPC='set/your/path/here'
PATH_PLOTS="set/your/path/here"

## Source functions ----
source(paste(PATH_FUNCTION,"/EEtradeoffs_functions.R", sep="") )

### Flags ----
## ESTIMATE THE EEI/EWA MODEL----
## This chunk of code estimates the EEI/EWA model
## To estimate the benchmark models, change flags for MODEL, DATA, INDDIFF, K (for EE/EWA)
## discount r for the discountEV models, model_code

## MODEL flags: "eei_ewa_mixed" - EEI/EWA proposed model; "discountEV" - EEI/EWA discountEV, "eei_mixed_noEWA" - EEI
## "ee_only_ewa_mixed" - EE/EWA; "eei_stat_ewa" - statEEI/EWA; "ewa_only" - EWA; 
MODEL= "eei_ewa_mixed"
INDDIFF=T # set to F for the EEI/EWA noPsychVars model
K=3 # set to 2 for EE/EWA model
r=.9 # set the discount level for discountEV (.5, .7, .9, or .95)


if(MODEL=="eei_ewa_mixed"){
  stancode=hmme_eei_ewa_mixed
  m = stan_model(model_code = stancode)
}else if (MODEL=="discountEV"){ 
  stancode=hmme_eei_ewa_mixed_discountEV
  m = stan_model(model_code = stancode)
}else if (MODEL=="ee_only_ewa_mixed"){ 
  stancode=hmme_ee_only_ewa_mixed
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_mixed_noEWA"){ 
  stancode = hmme_eei_mixed_noEWA
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_stat_ewa"){ 
  stancode=hmme_eei_stationary_ewa
  m = stan_model(model_code = stancode)
}else{ 
  stancode=ewa_only
  m = stan_model(model_code = stancode)
}

roundsData=read_csv(paste(PATH_DATA, "/businessTask_Study1.csv", sep="") ) 
psychData=read_csv(paste(PATH_DATA, "/psychVars_Study1.csv", sep="") ) 

roundsData=roundsData %>% 
  mutate(Rounds=rounds+1) %>% 
  group_by(userid) %>% 
  mutate(ID = cur_group_id(),
        lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup() %>% 
  arrange(ID, Rounds)

H=length(unique(roundsData$userid))
N_arms= 3
prior=50

ID=pull(roundsData, ID)
lastT=pull(roundsData, lastT)
y=pull(roundsData, picks)
T.length=pull(roundsData, Rounds)
X=pull(roundsData, results)

if (MODEL=="ee_only_ewa_mixed"){ 
  pi0=c(0.99999, 0.00001)
  z=c(1, 2)
  K=2
}else{ 
  pi0=c(0.99999, 0.000005, 0.000005)
  z=c(1, 2, 3)
  K=3
}

## random effects
inddif=psychData %>% 
  arrange(user_id) %>%
  mutate(iota=rep(1, H), RA=log(crra))%>%
  dplyr::select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (i in 2:ncol(indcen))
  indcen[,i]=indcen[ ,i]-mean(indcen[ ,i])

if(INDDIFF) {u=indcen
}else{ u=as.matrix(indcen[,1]) }

ndem=ncol(u)
Nobs=100
nvar=3

##* Define stan dataset -----
stan.data = list(
  N=nrow(roundsData), # number of observations
  H=H, # number of individuals
  K=K, # number of hidden states
  nvar_ind=3,
  N_arms=N_arms, # number of possible choices   
  lastT=pull(roundsData, lastT),
  ID=pull(roundsData, ID),                            # vector of indivIDual index
  y=pull(roundsData, picks),
  prior=rep(prior, N_arms),
  X=pull(roundsData, results),
  T=pull(roundsData, Rounds),
  D=2,
  pi0=pi0,
  N0=1,
  z=z,
  u=u,
  ndem=ncol(u),
  r=r
 )

##* Run the model ----
## note: runtime is approx. 50 hours
EEI_EWA_stanfit <- stan(model_code = stancode, data = stan.data,
                          verbose = TRUE, chains = 2,
                          seed = 123456, iter =4000, warmup=3000, 
                          control = list(adapt_delta=0.99, max_treedepth=15))

print(object.size(EEI_EWA_mixed), units = "auto") 
##* Save stanfit object ----
setwd(PATH_RESULTS)
save(EEI_EWA_stanfit, file="EEI_EWA_stanfit.RData")

## ESTIMATION RESULTS ----
#* compute dummy variable for dissapointing / encouraging outcomes (GL) ----
roundsData_withGL=roundsData %>% group_by(userid) %>% 
  mutate(lagX=lag(results) ) %>% 
  mutate(lagX=replace(lagX, is.na(lagX), 50)) %>% 
  mutate(Xmean=cumsum(lagX)/Rounds) %>% 
  mutate(leadGL=ifelse(results<Xmean, 1, 0)) %>% 
  mutate(GL=lag(leadGL)) %>% 
  mutate(GL=replace(GL, is.na(GL), 0)) %>% 
  ungroup()
head(roundsData_withGL)

## Transition probabilities and state membership probabilities ----
#* Variation in transition probabilities, based on estimated parameters -----
## Table 3 - Averages and 95% HDIs for the posterior state transitions, 
## following disappointing or encouraging outcomes
XD=matrix(c(1, 1, 1, 0), ncol=2)
beta_base<- summary(EEI_EWA_stanfit, 
                    pars = c("gamma[1,1]", "gamma[1,2]",
                             "gamma[1,3]", "gamma[1,4]", 
                             "gamma[1,5]", "gamma[1,6]"), 
                    probs=c(0.025, 0.975), digits=3)$summary
beta_base=beta_base[,c(1, 4, 5)]
beta_D<- summary(EEI_EWA_stanfit, 
                 pars = c("betaD"), 
                 probs=c(0.025, 0.975), digits=3)$summary
beta_D=beta_D[,c(1, 4, 5)]

#** encouraging outcomes ----
Qij_mean=Qij_025=Qij_975=NULL

### from Exploration - mean
beta1_mean=matrix(c(beta_base[1:2,1], 0, beta_D[1:2,1], 0), nrow=K)
Qij <- softmax(XD[2,]%*%t(beta1_mean))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
beta1_2.5=matrix(c(beta_base[1:2,2], 0, beta_D[1:2,2], 0), nrow=K)
Qij <- softmax(XD[2,]%*%t(beta1_2.5))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
beta1_97.5=matrix(c(beta_base[1:2,3], 0, beta_D[1:2,3], 0), nrow=K)
Qij <- softmax(XD[2,]%*%t(beta1_97.5))
(Qij_975=rbind(Qij_975, Qij))

### from Exploitation- mean
(beta1_mean=matrix(c(beta_base[3:4,1], 0, beta_D[3:4,1], 0), nrow=K))
(Qij <- softmax(XD[2,]%*%t(beta1_mean)))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
(beta1_2.5=matrix(c(beta_base[3:4,2], 0, beta_D[3:4,2], 0), nrow=K))
(Qij <- softmax(XD[2,]%*%t(beta1_2.5)))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
(beta1_97.5=matrix(c(beta_base[3:4,3], 0, beta_D[3:4,3], 0), nrow=K))
(Qij <- softmax(XD[2,]%*%t(beta1_97.5)))
(Qij_975=rbind(Qij_975, Qij))

### from Inertia - mean
beta1_mean=matrix(c(beta_base[5:6,1], 0, beta_D[5:6,1], 0), nrow=K)
Qij <- softmax(XD[2,]%*%t(beta1_mean))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
(beta1_2.5=matrix(c(beta_base[5:6,2], 0, beta_D[5:6,2], 0), nrow=K))
(Qij <- softmax(XD[2,]%*%t(beta1_2.5)))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
(beta1_97.5=matrix(c(beta_base[5:6,3], 0, beta_D[5:6,3], 0), nrow=K))
(Qij <- softmax(XD[2,]%*%t(beta1_97.5)))
(Qij_975=rbind(Qij_975, Qij))

Qij_encouraging_mean=Qij_mean
Qij_encouraging_025=Qij_025
Qij_encouraging_975=Qij_975

#** disappointing outcomes ----
Qij_mean=Qij_025=Qij_975=NULL

### from Exploration - mean
beta1_mean=matrix(c(beta_base[1:2,1], 0, beta_D[1:2,1], 0), nrow=K)
Qij <- softmax(XD[1,]%*%t(beta1_mean))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
beta1_2.5=matrix(c(beta_base[1:2,2], 0, beta_D[1:2,2], 0), nrow=K)
Qij <- softmax(XD[1,]%*%t(beta1_2.5))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
beta1_97.5=matrix(c(beta_base[1:2,3], 0, beta_D[1:2,3], 0), nrow=K)
Qij <- softmax(XD[1,]%*%t(beta1_97.5))
(Qij_975=rbind(Qij_975, Qij))

### from Exploitation- mean
beta1_mean=matrix(c(beta_base[3:4,1], 0, beta_D[3:4,1], 0), nrow=K)
Qij <- softmax(XD[1,]%*%t(beta1_mean))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
(beta1_2.5=matrix(c(beta_base[3:4,2], 0, beta_D[3:4,2], 0), nrow=K))
(Qij <- softmax(XD[1,]%*%t(beta1_2.5)))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
(beta1_97.5=matrix(c(beta_base[3:4,3], 0, beta_D[3:4,3], 0), nrow=K))
(Qij <- softmax(XD[1,]%*%t(beta1_97.5)))
(Qij_975=rbind(Qij_975, Qij))

### from Inertia- mean
beta1_mean=matrix(c(beta_base[5:6,1], 0, beta_D[5:6,1], 0), nrow=K)
Qij <- softmax(XD[1,]%*%t(beta1_mean))
(Qij_mean=rbind(Qij_mean, Qij))

## 2.5 CI
beta1_2.5=matrix(c(beta_base[5:6,2], 0, beta_D[5:6,2], 0), nrow=K)
(Qij <- softmax(XD[1,]%*%t(beta1_2.5)))
(Qij_025=rbind(Qij_025, Qij))

## 97.5 CI
beta1_97.5=matrix(c(beta_base[5:6,3], 0, beta_D[5:6,3], 0), nrow=K)
(Qij <- softmax(XD[1,]%*%t(beta1_97.5)))
(Qij_975=rbind(Qij_975, Qij))

Qij_disappointing_mean=Qij_mean
Qij_disappointing_025=Qij_025
Qij_disappointing_975=Qij_975

Qij_ED_mean=cbind(Qij_disappointing_mean, Qij_encouraging)
stargazer(Qij_ED_mean, summary=F)

#* Average membership probs plots ----
## for Figure 8 -Probabilities of sampling strategies across rounds, following disappointing or encouraging outcomes
## state membership probabilities from generated quantities
alpha_tk <- rstan::extract(EEI_EWA_stanfit, pars = 'alpha_tk')[[1]]
alpha_mean=matrix(colMeans(alpha_tk), ncol=K) 
colnames(alpha_mean)=c("Explore", "Exploit", "Inertia")

a=roundsData_withGL %>% 
  cbind(alpha_mean) %>% 
  group_by(Rounds, GL) %>% 
  summarise(pbEe=mean(Explore), pbEt=mean(Exploit), pbC=mean(Inertia)) %>% 
  ungroup() 
colnames(a)=c("Round", "GL","Explore", "Exploit", "Inertia")

a=a %>%  
  mutate(GL=if_else(GL==1, "Following disappointing outcomes", "Following encouraging outcomes" )) %>% 
  pivot_longer(-c(Round, GL), names_to = "State", values_to = "Prob")

a$State=factor(a$State, levels = c("Explore", "Exploit", "Inertia"))

alphaTR=a %>% ggplot(aes(x=Round, y=Prob, fill=State))+
  geom_bar(stat="identity")+
  labs(y="State membership probability", fill="Probability to")+
  scale_fill_manual(values=c("#C1CDCD", "#668B8B", "#454545"))+
  theme_light()+theme(legend.position = "bottom") +
  facet_wrap(.~GL)

alphaTR

plot_scale <- 4.5
plot_aspect <- 2
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'membership_prob_GL.pdf') )

#* Membership probs across rounds per subject ----
## For figure 10 - Subject-level choice of arm and state membership probabilities across rounds
estimated = apply(apply(alpha_tk, c(2, 3), median), 1, which.is.max)
alphatk=apply(alpha_tk, c(2, 3), median)

colnames(alphatk)=c("Prob_explore", "Prob_exploit", "Prob_inertia")
roundsData %<>% cbind(alphatk)
## pick subjects
temp=c(4, 3,46)

p=roundsData %>% filter(userid %in% temp) %>%
  ggplot(aes(x=rounds, y=picks-4))+
  geom_point(aes(shape=as.factor(picks)))+
  scale_y_continuous(name="Choice of arm", breaks=c(-3, -2, -1), labels= c("1", "2", "3"))+
  labs(x="", shape="Choice of arm")+
  theme_light()+theme(legend.position="none")
p1=p1+facet_wrap(~ userid, ncol=3, labeller = as_labeller( c("1"="Subject 1", "2"="Subject 2", "3"="Subject 3",
                                                             "4"="Subject 4", "21"="Subject 21", "46"="Subject 46")))

p2=roundsData %>% filter(userid %in% temp) %>%
  ggplot(aes(x=rounds))+
  # geom_point(aes(shape=as.factor(picks)))
  geom_line(aes(x=rounds, y=Prob_explore, color="a"),size=1.03)+
  geom_line(aes(x=rounds, y=Prob_exploit, color="b"),size=1.03)+
  geom_line(aes(x=rounds, y=Prob_inertia, color="c"), size=1.03)+
  scale_y_continuous(name="State membership probability", breaks=c(0,1))+
  scale_color_manual(values= c("a"="#C1CDCD", "b"= "#668B8B", "c"="#454545"),
                     labels=c("Explore", "Exploit", "Inertia"))+
  labs(x="Round", color="Probability to")+
  theme_light()+theme(legend.position="bottom")
p2=p2+facet_wrap(~ userid, ncol=3)+  
  theme(
    strip.background = element_blank(),
    strip.text.x = element_blank()
  )

a=grid.arrange(p1, p2, ncol=1)

plot_scale <- 5
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/z_filtered_VD_probs_v2.pdf') )

### Observed choice probabilities plots ----
## For figure 9 - Choice probability densities conditional on sampling strategy
## choice probabilities from generated quantities
empb_g <- rstan::extract(EEI_EWA_stanfit, pars = 'empb_n')[[1]]
empb_med=apply(empb_g, c(2, 3, 4), median)
Niter=length(empb_g[, 1, 1, 1])
rm(empb_g)
N=Nobs*H
empb_med_Sest=matrix( , nrow=N, ncol=N_arms)

for (n in 1:N)
{empb_med_Sest[n,]=empb_med[n, estimated[n], ]}

colnames(empb_med_Sest)=c("obs_probs1", "obs_probs2", "obs_probs3")

obs_probs_density=roundsData %>% bind_cols(as.data.frame(estimated)) %>%
  cbind(as.data.frame(empb_med_Sest)) %>% 
  select(userid, estimated, starts_with("obs_")) %>%
  gather(obs_probs, value, -userid, -estimated) %>%
  mutate(estimated_labeled=case_when(estimated==1 ~ "Explore",
                                     estimated==2 ~ "Exploit",
                                     TRUE ~ "Inertia")) %>% 
  arrange(estimated)
nrow(obs_probs_density %>% filter(estimated_labeled=="Explore"))/ 
  nrow(obs_probs_density)

obs_probs_density %>% 
  mutate(estimated_labeled=fct_reorder(estimated_labeled, estimated)) %>% 
  ggplot(aes(x = value, fill = obs_probs)) +
  geom_density(alpha=0.5)+
  scale_fill_manual(name="Choice of", labels=c(obs_probs1="Arm 1", obs_probs2="Arm 2", obs_probs3="Arm 3"),
                    values = c("brown2", "blue2", "darkolivegreen3"))+
  scale_y_continuous(name="Density")+
  scale_x_continuous(name="Probability", breaks = c(0, 0.25, .5, 0.75, 1), labels = c("0", "0.25", "0.5", "0.75", "1"))+
  theme_light()+theme(legend.position="bottom")+
  facet_wrap(.~estimated_labeled)

plot_scale <- 3
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'choice_probs_give_eststate.pdf'))

### HETEROGENEITY PLOTS ----
#* parameter tables ----
pars_hetpsych = c("gamma[2,1]", "gamma[2,2]", "gamma[2,3]", "gamma[2,4]", "gamma[2,5]", "gamma[2,6]", "gamma[2,7]", "gamma[2,8]","gamma[2,9]",
                  "gamma[3,1]", "gamma[3,2]", "gamma[3,3]", "gamma[3,4]", "gamma[3,5]", "gamma[3,6]", "gamma[3,7]", "gamma[3,8]","gamma[3,9]",
                  "gamma[4,1]", "gamma[4,2]", "gamma[4,3]", "gamma[4,4]", "gamma[4,5]", "gamma[4,6]", "gamma[4,7]", "gamma[4,8]","gamma[4,9]",
                  "gamma[5,1]", "gamma[5,2]", "gamma[5,3]", "gamma[5,4]", "gamma[5,5]", "gamma[5,6]", "gamma[5,7]", "gamma[5,8]","gamma[5,9]")

#* Heteorgeneity plots - impact of psychometrics ----
## Figure 11 - Means and 95%HDIs of the parameters estimating the impact of psychometric traits on the (untransformed) behavioral parameters
delta_psych_het<- t(as.matrix(EEI_inddif_mixed_ovXmean_2l, pars = pars_hetpsych))
Niter=ncol(delta_psych_het)
colnames(delta_psych_het)=paste0(rep("niter", Niter), 1:Niter)
delta_psych=as_tibble(delta_psych_het) %>% 
  mutate(Bpars=rep(c("B_011", "B_012", "B_021", "B_022", "B_031", "B_032", "lambda", "rho", "phi"), 4),
         Psych_pars=c(rep("Risk preferences",9), rep("Analytical DMS", 9), rep("Intuitive DMS",9), rep("Tendency to maximize", 9))) %>%
  mutate(Significant=case_when(Bpars=="B_011" & Psych_pars=="Risk preferences"~1,
                               Bpars=="rho" & Psych_pars=="Analytical DMS"~1,
                               Bpars=="lambda" & Psych_pars=="Tendency to maximize"~1,
                               TRUE~0)) %>% 
  pivot_longer(starts_with("niter"), names_to="iter", values_to="value")

delta_psych$Psych_pars=factor(delta_psych$Psych_pars, levels = c("Risk preferences", "Tendency to maximize", "Analytical DMS", "Intuitive DMS"))

delta_meanHDI_plot=delta_psych %>%  
  ggplot(aes(x = Bpars, y = value, color=as.factor(Significant))) +
  stat_summary(fun = median,
               fun.min = function(z) {quantile(z,0.025)},
               fun.max = function(z) {quantile(z,0.975)},
               geom="pointrange")+
  labs(x = 'Behavioral parameters', y = 'Impact of psychometric traits') +
  scale_x_discrete(labels=c("B_011"=expression(paste(beta[0/11])), 
                            "B_012"=expression(paste(beta[0/12])), "B_021"=expression(paste(beta[0/21])), 
                            "B_022"=expression(paste(beta[0/22])), "B_031"=expression(paste(beta[0/31])),
                            "B_032"=expression(paste(beta[0/32])), "lambda"=expression(paste(lambda^"Exploit")), 
                            "rho"=expression(rho), "phi"=expression(phi)))+
  geom_hline(yintercept=0, color="gray60")+
  scale_color_manual(values=c("gray60", "black"))+
  facet_wrap(.~Psych_pars, ncol=2)+
  theme_light()+theme(legend.position="none")

delta_meanHDI_plot

plot_scale <- 4.5
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/MCI_psych_het.pdf') )

#* Figure WA7 - Heterogeneity in subjects' sensitivity to attractions ----
actualR=roundsData %>% group_by(ID) %>% 
  summarise(Actual=sum(results)) %>% 
  ungroup() %>% 
  mutate( Actual_med_split=ifelse(Actual< median(Actual), "Low", "High"))
actualR$Actual_med_split=factor(actualR$Actual_med_split, levels=c("Low", "High"))

lambda_exploit_het <- t(as.matrix(EEI_inddif_mixed_ovXmean_2l,pars = "lambda_exploit"))#[nwarmup:niter,]
lambda_exploit_het_ss=t( apply(lambda_exploit_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(lambda_exploit_het_ss)=c("l025", "l5", "l975")

lambda_het_plot=data.frame(ID=1:H, lambda_exploit_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

plambda= ggplot(data=lambda_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = lambda_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1), name="Total rewards")+
  labs(y = "Parameter",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

plambda

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'lambda_exploit_RMS.pdf') )

## Table WA11 regression 
a=lm(Actual~l5, data=lambda_het_plot)
summary(a)

##* Figure WA8 - Heterogeneity in decay rates of previous attractions (left), and experience (right) of subjects----
#** rho ----
rho_het <- t(as.matrix(EEI_EWA_stanfit, pars = "rho"))#[nwarmup:niter,]
rho_het_ss=t( apply(rho_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(rho_het_ss)=c("r025", "r5", "r975")

rho_het_plot=data.frame(ID=1:H, rho_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

prho= ggplot(data=rho_het_plot,
             aes(reorder(ID,r5), ymin=r025, ymax=r975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = rho_het_plot,
             aes(reorder(ID, r5), y = r5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y = "Parameter", x = "Subjects (ordered)")+
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
prho

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'rho_RMS.pdf') ) 

## Table WA11 regression
a=lm(Actual~r5, data=rho_het_plot)
summary(a)

#** phi ----
phi_het <- t(as.matrix(EEI_EWA_stanfit, pars = "phi"))
phi_het_ss=t( apply(phi_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(phi_het_ss)=c("p025", "p5", "p975")

phi_het_plot=data.frame(ID=1:H, phi_het_ss)%>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pphi= ggplot(data=phi_het_plot,
             aes(reorder(ID,p5), ymin=p025, ymax=p975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = phi_het_plot,
             aes(reorder(ID, p5), y = p5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y = "Parameter",  x = "Subjects (ordered)")+
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pphi

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'phi_RMS.pdf') )

## Table WA11 regression
a=lm(Actual~p5, data=phi_het_plot)
summary(a)

##* Figure WA6 Heterogeneity in parameter estimates showing baseline tendencies to transition between sampling strategies ----
######## lambda_exploit
beta_het <- t(as.matrix(EEI_EWA_stanfit, pars = "delta"))
Parameter=c(rep("Baseline Explore(t) | Explore(t-1)", H), rep("Baseline Explore(t) | Exploit(t-1)", H),
            rep("Baseline Exploit(t) | Explore(t-1)", H), rep("Baseline Exploit(t) | Exploit(t-1)", H),
            rep("Baseline Inertia(t) | Explore(t-1)", H), rep("Baseline Inertia(t) | Explore(t-1)", H))
beta11_het=beta_het[1:H,]
beta11_het_ss=t( apply(beta11_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta11_het_ss)=c("l025", "l5", "l975")

beta11_het_plot=data.frame(ID=1:H, beta11_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta11= ggplot(data=beta11_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta11_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y="Parameter",title = "Baseline Explore(t) | Explore(t-1)",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta11

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Explore1_RMS.pdf') )

a=lm(Actual~l5, data=beta11_het_plot)
summary(a)

## beta12 
beta12_het=beta_het[H+1:H,]
beta12_het_ss=t( apply(beta12_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta12_het_ss)=c("l025", "l5", "l975")

beta12_het_plot=data.frame(ID=1:H, beta12_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta12= ggplot(data=beta12_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta12_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y="", title = "Baseline Exploit(t) | Explore(t-1)",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta12

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Explore2_RMS.pdf') )

a=lm(Actual~l5, data=beta12_het_plot)
summary(a)

## beta21 - prob explore given exploit
beta21_het=beta_het[2*H+1:H,]
beta21_het_ss=t( apply(beta21_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta21_het_ss)=c("l025", "l5", "l975")

beta21_het_plot=data.frame(ID=1:H, beta21_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta21= ggplot(data=beta21_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta21_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y ="Parameter", title= "Baseline Explore(t) | Exploit(t-1)",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta21

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Exploit1_RMS.pdf') )

a=lm(Actual~l5, data=beta21_het_plot)
summary(a)

## beta22 - prob exploit given exploit
beta22_het=beta_het[3*H+1:H,]
beta22_het_ss=t( apply(beta22_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta22_het_ss)=c("l025", "l5", "l975")

beta22_het_plot=data.frame(ID=1:H, beta22_het_ss) %>% 
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta22= ggplot(data=beta22_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta22_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y="", title = "Baseline Exploit(t) | Exploit(t-1)",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta22

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Exploit2_RMS.pdf') )

a=lm(Actual~l5, data=beta22_het_plot)
summary(a)

## beta31 - prob explore given inertia
beta31_het=beta_het[4*H+1:H,]
beta31_het_ss=t( apply(beta31_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta31_het_ss)=c("l025", "l5", "l975")

beta31_het_plot=data.frame(ID=1:H, beta31_het_ss)  %>%  
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta31= ggplot(data=beta31_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta31_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y = "Parameter", title= "Baseline Explore(t) | Inertia(t-1)",x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta31

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Inertia1_RMS.pdf') )

a=lm(Actual~l5, data=beta31_het_plot)
summary(a)

## beta32 - prob exploit given inertia
beta32_het=beta_het[5*H+1:H,]
beta32_het_ss=t(apply(beta32_het,1, quantile,probs =c(.25,0.5, 0.75)))
colnames(beta32_het_ss)=c("l025", "l5", "l975")

beta32_het_plot=data.frame(ID=1:H, beta32_het_ss)  %>%   
  bind_cols(actualR %>% dplyr::select(Actual, Actual_med_split))

pbeta32= ggplot(data=beta32_het_plot,
                aes(reorder(ID,l5), ymin=l025, ymax=l975, linetype=as.factor(Actual_med_split)))+
  geom_linerange(size=.8) +
  geom_point(data = beta32_het_plot,
             aes(reorder(ID, l5), y = l5), size = 1)+
  scale_linetype_manual(values= c(2,1),
                        labels=c("Low", "High"), name="Total rewards")+
  labs(y = "", title="Baseline Exploit(t) | Inertia(t-1)", x = "Subjects (ordered)") +
  theme_light()+theme(legend.position="bottom")+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())

pbeta32

plot_scale <- 6
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Inertia2_RMS.pdf') )

a=lm(Actual~l5, data=beta32_het_plot)
summary(a)

### PP CHECKS ----
#* PP checks of percentage switching ----
## Replicates analysis in 6.1.2 and Figure 12, and analysis in WA4 and Figure WA2 
## The code here shows the pp checks for the EEI/EWA model
load(paste0(PATH_RESULTS, "/EEI_EWA_stanfit.RData"))
y=pull(roundsData, picks)
set.seed(123456)
MODEL = "EEI/EWA"
ppc_switch_data=ppc_switch_Sdecile(dataset=roundsData, 
                                   stfit=EEI_EWA_stanfit, 
                                   MODEL=MODEL)
write_csv(ppc_switch_data, paste0(PATH_PPC, "/ppc_switch_data_eei_ewa.csv" ))
## Replicate the analysis above (previous 9 lines) for each benchmark model 
## import stanfit object per model, change MODEL, stfit file, .csv file name
## set K=2 for EE/EWA model, use function ppc_switch_ewa_Sdecile() for the EWA model
## This saves a .csv file for each benchmark model.

##* Load ppc checks ----
## Imports all .csv files 
PPC_switch_over_models <- list.files(path=PATH_PPC, full.names = TRUE) %>%
  lapply(read.delim, sep=",") %>%
  bind_rows

PPC_switch_over_models = as_tibble(PPC_switch_over_models)%>% 
  mutate(MAE_switch=abs(obs_switches-ppc_switch))

mae_ppc=PPC_switch_over_models %>% 
  group_by(userid) %>% 
  summarise(obs_switch_user=mean(obs_switches)) %>% 
  mutate(switch_decile = ntile(obs_switch_user, 10)) %>% 
  ungroup() %>% 
  full_join(PPC_switch_over_models) 

mae_ppc$Model=factor(mae_ppc$Model, 
                     levels = c("EEI", "EWA", "EE/EWA", "statEEI/EWA", "EEI/EWA no PsychVars", 
                                "EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", 
                                "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA"))

## MAE across all models, reported in tables 4 and WA4
mae_overall=PPC_switch_over_models%>% 
  group_by(Model) %>% 
  summarise(obs=mean(obs_switches), 
            ppc=mean(ppc_switch), 
            mae=round(mean(MAE_switch), 3) )

## Figure 12 left - ppc_switch_mainComponents
plot_ppc_mainComponents=mae_ppc %>% 
  filter(Model %in% c("EEI", "EWA", "EEI/EWA")) %>% 
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=1:10)+
  scale_color_manual( values=c("#668B8B", "#C1CDCD", "darkblue"))+
  labs(y = 'Percentage switches') + #Mean absolute error
  theme_light()+theme(legend.position="bottom")
plot_ppc_basicModels

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/plot_ppc_switch_mainComponents.pdf'))

#Figure 12 right - ppc_switch_keyFeatures
plot_ppc_keyFeatures=mae_ppc %>% 
  filter(Model %in% c("EE/EWA", "statEEI/EWA", "EEI/EWA no PsychVars", "EEI/EWA")) %>% 
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot,position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=1:10)+
  scale_color_manual(values=c( "#C1CDCD","#668B8B", "#8673D0", "darkblue"))+
  labs(y = 'Percentage switches')+
  theme_light()+theme(legend.position="bottom")
plot_ppc_keyFeatures

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/plot_ppc_switch_keyFeatures.pdf'))

## Figure WA2
plot_ppc_discountModels=mae_ppc %>% 
  filter(Model %in% c("EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA")) %>%
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=1:10)+
  scale_color_manual(values=c("darkgreen", "#668B8B", "#C1CDCD", "#8673D0", "darkblue"), 
                     labels=c("Discount .5", "Discount .7", "Discount .9", "Discount .95", "EEI/EWA"))+
  labs(y = 'Percentage switches') +
  theme_light()+theme(legend.position="bottom")
plot_ppc_discountModels

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, '/plot_ppc_switch_discountModels.pdf'))

## IN-SAMPLE FIT ----
if(MODEL=="ewa"){
  ## change according to the stanfit objects
  insample=InSample_EWA(EWA_stanfit, roundsData)
}else {
  insample=InSample_stats(EEI_EWA_stanfit, roundsData)
}

stargazer(insample, summary = F, digits=3, align = T)
