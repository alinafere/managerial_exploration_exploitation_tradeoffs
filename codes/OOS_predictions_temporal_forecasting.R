## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021

## Out-of-sample predictions - Temporal forecasting
## This exemplifies the anlaysis for the EEI/EWA model 
## Change MODEL, INDDIFF, and r flags to run the analysis for all models

## load required packages ----
rm(list=ls())
library(loo)
library(nnet)
library(rstan)
library(tidyverse)
library(stargazer)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

## Set paths ---- 
PATH_FUNCTION= "/set/local/path/here" 
PATH_DATA="/set/local/path/here"
PATH_RESULTS="/set/local/path/here"

## Source functions ----
source(paste0(PATH_FUNCTION,"/EEtradeoffs_functions.R") )

### Flags ----
## "eei_ewa_mixed" - EEI/EWA proposed model; "discountEV" - EEI/EWA discountEV, "eei_mixed_noEWA" - EEI
## "ee_only_ewa_mixed" - EE/EWA; "eei_stat_ewa" - statEEI/EWA; "ewa_only" - EWA; 
MODEL= "eei_ewa_mixed"
INDDIFF=T # change to F for EEI/EWA noPsychVars model
r=.9 # set the discount level for discountEV (.5, .7, .9, .95)

if(MODEL=="eei_ewa_mixed"){
  stancode=hmme_eei_ewa_mixed_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="discountEV"){ 
  stancode=hmme_eei_ewa_mixed_discountEV_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="ee_only_ewa_mixed"){ 
  stancode=hmme_ee_only_ewa_mixed_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_mixed_noEWA"){ 
  stancode = hmme_eei_mixed_noEWA_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_stat_ewa"){ 
  stancode=hmme_eei_stationary_ewa_oos
  m = stan_model(model_code = stancode)
}else{ 
  stancode=ewa_only_oos
  m = stan_model(model_code = stancode)
}

## Import data ----
roundsData=read_csv(paste(PATH_DATA, "/businessTask_Study1.csv", sep="") ) 
psychData=read_csv(paste(PATH_DATA, "/psychVars_Study1.csv", sep="") ) 

roundsData=roundsData %>% 
  mutate(Rounds=rounds+1) %>% 
  group_by(userid) %>% 
  mutate(ID = cur_group_id()) %>% 
  ungroup() %>% 
  arrange(ID, Rounds)

H=length(unique(roundsData$userid))
N_arms= 3
prior=50
D=2
N0=1

if (MODEL=="ee_only_ewa_mixed"){ 
  pi0=c(0.99999, 0.00001)
  z=c(1, 2)
  K=2
  }else{ 
  pi0=c(0.99999, 0.000005, 0.000005)
  z=c(1, 2, 3)
  K=3
}

## random effects
inddif=psychData %>% 
  mutate(iota=rep(1, H), RA=log(crra))%>%
  select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (j in 2:ncol(indcen))
  indcen[,j]=indcen[ ,j]-mean(indcen[ ,j])
head(indcen)

if(INDDIFF) {u=indcen
  }else{ u=as.matrix(indcen[,1]) }

Nobs=max(roundsData$Rounds)
## use first oos_T=80 rounds of each subject's history for calibration
oos_T=80

## Estimate the model ----
est_dataset=roundsData %>% filter(Rounds %in% 1:oos_T) %>% 
  group_by(userid) %>% 
  mutate(lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup()

pred_dataset =  roundsData %>% filter(Rounds %in% (oos_T+1):Nobs )
  
stan.data = list(
  N=length(est_dataset$picks), # number of observations
  H=H,             # number of individuals
  K=K,            # number of hidden states
  nvar_ind=3, ## only necessary for EWA model
  N_arms=N_arms,  # number of possible choices
  T=pull(est_dataset, Rounds),   # vector for the time series per individual
  lastT=pull(est_dataset, lastT),  # vector for the time series per indivIDual
  ID=pull(est_dataset, ID),    # vector of individual index
  y=pull(est_dataset, picks),
  prior=rep(prior, N_arms),
  X=pull(est_dataset, results),
  D=2,
  pi0=pi0,
  N0=1,
  z=z,
  u=u,
  ndem=ncol(u),
  r=r ## only necessary for discountEV models
  )

EEI_oos_predictions = stan(model_code = stancode, data = stan.data,
                                verbose = TRUE, chains = 2,
                                seed = 123456, iter = 4000, warmup = 3000, 
                                control = list(adapt_delta=0.99, max_treedepth=15))

setwd(PATH_RESULTS)
save.image(file=paste0(MODEL, "_oos_preds_stanfit.RData"))

## Run out-of-sample predictions ----
set.seed(123456)
## run OOS function for temporal forecasting
## change function when changing the model, mind the function inputs

## functions necessary for all models are available in EEtradeoffs_functions.R
OOS_i=out_of_sample_predictions(oos_t = oos_T, stfit = EEI_oos_predictions, dataset = pred_dataset)
Niter=2000
hr= tibble(hr=OOS_i[[1]])
mse=tibble(mse=OOS_i[[2]])

OOS_hrmse = hr %>% 
  bind_cols(mse %>% dplyr::select(mse)) %>% 
  mutate(iter=1:Niter, Model=rep(MODEL, n()))

##* Compute HR and MSE ----
##** HR and MSE for the EEI/EWA model----
OOS_hrmse %>% summarise(mean(hr), mean(mse))

## write an csv file with hr and mse per model  
setwd(paste0(PATH_RESULTS, "/OOS_measures" ) )
write_csv(OOS_hrmse, paste0("OOS_TF_hrmse_", MODEL,  ".csv")) 

##** Compute HR MSE across all models ----
## import datasets for all models
OOS_hrmse <- list.files(path=paste0(PATH_RESULTS, "/OOS_measures"), full.names = TRUE) %>%
  lapply(read.delim, sep=",") %>%
  bind_rows
OOS_hrmse_tf = as_tibble(OOS_hrmse_tf)

hrmse_overall=OOS_hrmse %>% 
  group_by(Model) %>% 
  summarise( mse=round(mean(mse), 3), hr=round(mean(hr), 3)*100) %>% 
  ungroup()
stargazer(hrmse_overall, summary=F, align=F)

##* Predicted switching behavior and MAE ---- 
##** Build observed switches and y_reps dataset per model ----
switch_obs=roundsData %>% 
  mutate(lag_picks=lag(picks, 1, 0)) %>% 
  mutate(obs_switches=ifelse(picks==lag_picks, 0, 1)) %>% 
  dplyr::select(userid, Rounds, picks, lag_picks, obs_switches) 
newRounds=(oos_T+1):Nobs

OOS_y=OOS_i[[3]]
yrep=t(OOS_y)
Niter=ncol(yrep)
colnames(yrep)=paste0("yrep_", 1:Niter)
yrep=as_tibble(yrep)

switch_obs_yrep= switch_obs %>% 
  filter(Rounds %in% newRounds) %>% 
  bind_cols(yrep) %>% 
  mutate(Model=MODEL)

## save yreps dataset per model 
setwd(paste0(PATH_RESULTS, "/OOS_switch") )
write_csv(oos_switch_data, paste0("OOS_switch_data_", MODEL, ".csv") )

##** Compute MAE across all models ----
## import datasets
PATH_RESULTS_MAE= paste0(PATH_RESULTS, "/OOS_switch")

OOS_switch_over_models <- list.files(path=PATH_RESULTS_MAE, full.names = TRUE) %>%
  lapply(read.delim, sep=",") %>%
  bind_rows
oos_switch_data = as_tibble(OOS_switch_over_models)

Niter=2000
yrep=oos_switch_data  %>% 
  dplyr::select(c(Model, starts_with("yrep")) )
lagYrep=yrep %>% group_by(Model) %>% 
  mutate_all(lag_yrep) %>% 
  ungroup()
  
switch_yrep=ifelse(yrep==lagYrep, 0, 1)
switch_yrep = as_tibble(switch_yrep) %>% dplyr::select(-Model)
colnames(switch_yrep)=paste0("yrep", 1:Niter)

oos_switch_data = oos_switch_data  %>% 
  dplyr::select(-starts_with("yrep")) %>% 
  bind_cols(as_tibble(switch_yrep)) %>% 
  filter(Rounds!=81) %>%  
  group_by(userid, Model) %>% 
  summarise_at(vars(obs_switches:paste0("yrep", Niter)), mean) %>% 
  pivot_longer(-c(Model, userid, obs_switches), names_to="iter", values_to = "ppc_switch") 

mae_within=oos_switch_data  %>% 
  group_by(userid) %>% 
  summarise(obs_switch_user=mean(obs_switches)) %>% 
  mutate(switch_decile = ntile(obs_switch_user, 10)) %>% 
  ungroup() %>% 
  full_join(oos_switch_data ) %>% 
  mutate(MAE_switch=abs(obs_switches-ppc_switch)) 

## mae per model, reported in Tables 5 (left) and WA5 (left)
mae_overall=oos_switch_data %>% 
  mutate(MAE_switch=abs(obs_switches-ppc_switch)) %>% 
  group_by(Model) %>% 
  summarise(mae=round(mean(MAE_switch), 3)) %>% 
  ungroup()
stargazer(mae_overall, summary=F,align=F)

## check decile mean, min, max
mae_within %>% group_by(switch_decile) %>% 
  summarise(count=n()/(Niter*10), minS=min(obs_switches), meanS=mean(obs_switches), 
            maxS=max(obs_switches))

##** Plot predocted switches over round deciles ---- 
## Figures 13 and WA3 (left)
mae_within$Model=factor(mae_within$Model, 
                         levels = c("EEI", "EWA", "EE/EWA", "statEEI/EWA", "EEI/EWA no PsychVars", 
                                    "EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", 
                                    "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA"))

plot_switch_within_basicModels=mae_within %>% 
  filter(Model %in% c("EEI", "EWA", "EEI/EWA")) %>% 
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual( values=c("#668B8B", "#C1CDCD", "darkblue"))+
  labs(y = 'Percentage switches')+#'Mean absolute error') +
  theme_light()+theme(legend.position="bottom")
plot_switch_within_basicModels

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'plot_OOS_switch_decile_within_basicModels.pdf') )

plot_switch_within_Components=mae_within %>% 
  filter(Model %in% c("statEEI/EWA", "EE/EWA", "EEI/EWA no PsychVars","EEI/EWA") ) %>%
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual(values=c( "#C1CDCD","#668B8B", "#8673D0", "darkblue"))+ 
  labs(y = 'Percentage switches')+
  theme_light()+theme(legend.position="bottom")

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'plot_OOS_switch_decile_within_Components.pdf') )


plot_switch_within_discountEV=mae_within %>% 
  filter(Model %in% c("EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA")) %>%
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.3)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual(values=c("darkgreen", "#668B8B", "#C1CDCD", "#8673D0", "darkblue"), 
                     labels=c("Discount .5", "Discount .7", "Discount .9", "Discount .95", "EEI/EWA"))+
  labs(y = 'Percentage switches')+
  theme_light()+theme(legend.position="bottom")

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'plot_OOS_switch_decile_within_discountEV.pdf') )

