## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021
# Counterfactual simulation study reported in Web Appendix WA7

## load required packages ----
rm(list=ls())
library(stargazer)
library(loo)
library(tidyverse)
library(forcats)

## Set paths ---- 
PATH_FUNCTION= "/set/local/path/here" 
PATH_DATA="/set/local/path/here"
PATH_RESULTS="/set/local/path/here"
PATH_PLOTS="/set/local/path/here"

## Source functions ----
source(paste0(PATH_FUNCTION,"/EEtradeoffs_functions.R") )

## Import data ----
psychData=read_csv(paste(PATH_DATA, "/psychVars_Study1.csv", sep="") ) 

## individual differences
inddif=psychData %>% 
  mutate(iota=rep(1, n()), RA=log(crra))%>%
  select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (i in 2:ncol(indcen))
  indcen[,i]=indcen[ ,i]-mean(indcen[ ,i])

#* Parameters----
K=3
D=2
nvarWA=3
nvarHMM=K*(K-1)
nvarD=(D-1)*K
nvar=nvarWA+nvarHMM
ndem=ncol(indcen)
lambda1_mean=-2.5 
pi0 = c(1, 0, 0)
betaD=c(1.4, 0.5, 0, 2.7, 1.2, 1.2)

## import parameters 
bsmall=read.csv(paste0(PATH_DATA, "/Counterfactual_analysis_heterogeneity_pars.csv") )
L_Omega=read.csv(paste0(PATH_DATA, "/Counterfactual_analysis_L_Omega.csv") )
tau=read.csv(paste0(PATH_DATA, "/Counterfactual_analysis_tau.csv"))

L_Omega_mean=matrix(L_Omega[ ,2], nrow=nvar)
tau_mean=matrix(tau[ ,2], nrow=nvar)
gamma_mean=matrix(bsmall[ ,2], nrow=nvar)

#* Data for X and y -----
set.seed(0123456789)
uncertain_reward=c(65, 50, 35) ## mean of the uncertain rewards of the 3 arms
sigma_w=15                      ## sd of the uncertain rewards of the arms (same for all 3)
prior=50
N0=1
N_arms= 3
H=89                        ## number of cross-sectional units
Nobs=100  					## number of observations per unit
rounds=1:100
ID=sort(rep(1:H,Nobs))

##* Psych profile - defviations on one dimension only ----
## Prototypical manager
psych_profileAv=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.5))
### The risk averse/ seeking
psych_profileRS=c(1, quantile(indcen[,2], 0.9), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.5))
psych_profileRA=c(1, quantile(indcen[,2], 0.1), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.5))

### The maximizers
psych_profileMz=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.9))
psych_profileSc=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.1))

### The analyticals
psych_profileADM=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.9), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.5))
psych_profileNADM=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.1), quantile(indcen[,4], 0.5),quantile(indcen[,5], 0.5))

### The intuitives
psych_profileIDM=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.9),quantile(indcen[,5], 0.5))
psych_profileNIDM=c(1, quantile(indcen[,2], 0.5), quantile(indcen[,3], 0.5), quantile(indcen[,4], 0.1),quantile(indcen[,5], 0.5))

Psych_profiles=rbind(psych_profileAv, psych_profileRA, psych_profileRS, psych_profileNADM, psych_profileADM, psych_profileNIDM, psych_profileIDM, psych_profileSc, psych_profileMz)
Psych_profiles_names=c("Av", "RA", "RS", "NADM", "ADM","NIDM", "IDM", "Sc", "Mz")
colnames(Psych_profiles)= c("iota", "risk", "analytical", "intuitive","satisficing")

## Simulation for psychological profiles ----
Combo_data=ee_data=NULL
niter=1000
n_profiles=nrow(Psych_profiles)
for (j in 1:n_profiles)
{

  ## simulate states
  strue=NULL
  ## Observation eq.
  ysim=Xsim=NULL
  y <- vector("numeric", Nobs)
  X <- vector("numeric", Nobs)
  W_Average_sim= probs=matrix(, ncol=N_arms, nrow=Nobs)
  
  emprobs=matrix(, ncol=N_arms, nrow=Nobs)
  Qij=matrix(, ncol=K, nrow=Nobs)
  
for (i in 1:niter){
  gamma=matrix(gamma_mean, ncol=nvar)

  Delta= t(Psych_profiles[j,]) %*% gamma
  beta=as.vector(t(Delta)+diag(c(tau_mean))%*%L_Omega_mean%*%as.matrix(rnorm(nvar, 0, 1)))

  lambda1= inv_logit(lambda1_mean)
  lambda2=inv_logit(lambda1_mean+exp(beta[7]))
  rho=inv_logit(beta[8])
  phi=inv_logit(beta[9])
  
  betaM=array(,dim=c(K,D,K))
  for(k in 1:K)
  {betaM[,,k]= matrix(c(beta[((k-1)*(K-1)+1):(k*(K-1))], 0, betaD[((k-1)*(K-1)+1):(k*(K-1))], 0), ncol=D)};
  # transition matrix and states
  sind=gl=vector("numeric", Nobs)
  sind[1]= sample(x = 1:K, size = 1, prob = pi0)
  trprobs=pi0
  
  ## draw a choice from p(y|explore)
  emprobs[1, ]=c(0.333333, 0.333333, 0.333334);
  
  ew=rep(N0, N_arms);
  W_Average=rep(prior,N_arms);
  y[1]=sample(x = 1:N_arms, size = 1, prob = emprobs[1, ])
  X[1]=abs(round(rnorm(1, uncertain_reward[y[1]], sigma_w),0))
  gl[1]=ifelse(X[1]>prior, 0, 1);
  
  for (t in 2:Nobs) {
    XD=c(1, gl[t-1]);
    
    Qij[t, ] <- softmax(t(XD)%*%t(betaM[,,sind[t-1]]))
    sind[t] <- sample(x = 1:K, size = 1, prob = Qij[t, ])
    
    ew1=ew[y[t-1]];
    ew[y[t-1]]=rho*ew[y[t-1]]+1;
    W_Average[y[t-1]]=(phi*ew1*W_Average[y[t-1]]+X[t-1])/ew[y[t-1]];
    W_Average_sim[t,]=W_Average

    if(sind[t]==1) {
      ## State 1 - exploration;
      emprobs[t, ]=softmax(lambda1*W_Average)
    }else if (sind[t]==2) {
      ## State 2 - exploitation;
      emprobs[t, ]=softmax(lambda2*W_Average);
    }else{
      ## State 3 - inertia;
      emprobs[t, ]=rep(0.000025, N_arms);
      emprobs[t, y[t-1]]=0.99995
    }
    
    y[t]=sample(1:N_arms, size = 1, prob = emprobs[t, ])
    X[t]=abs(round(rnorm(1, uncertain_reward[y[t]], sigma_w),0))
    Xmean=mean(c(prior, X[1:(t-1)]))
    gl[t]=ifelse(X[t]>Xmean,0, 1);
    
  }
  
  ysim=rbind(ysim, y)
  Xsim=rbind(Xsim, X)
  strue=rbind(strue, sind)
}

tot_rewards=as.vector(rowSums(Xsim))
print(j)

Combo_data=rbind(Combo_data, tot_rewards)
ee_data=rbind(ee_data,  c(table(strue)))
}

##* Psych profile plot ----
combo_data_small=t(rbind(apply(Combo_data ,1, quantile, probs =c(.25,0.5, 0.75)), 
                         apply(Combo_data ,1, function(x) sd(x)/sqrt(niter))))
colnames(combo_data_small)=c("l025", "l5", "l975", "se_mean")
### psych profiles
combo_data_plot=data.frame(ID=1:nrow(combo_data_small), combo_data_small)  %>% 
  mutate(PP_names=case_when(
    ID == 1 ~ "Prototypical",
    ID == 2 ~ "Risk-averse",
    ID == 3 ~ "Risk-seeking",
    ID == 4 ~ "Non-analytical",
    ID == 5 ~ "Analytical",
    ID == 6 ~ "Non-intuitive",
    ID == 7 ~ "Intuitive",
    ID == 8 ~ "Satisficer",
    TRUE~"Maximizer"
  ))

pcombo_plot= ggplot(data=combo_data_plot,
                aes(y=reorder(PP_names,l5), xmin=l5-1.96*se_mean, xmax=l5+1.96*se_mean))+
  geom_errorbarh(height=0, size=.8) +
  geom_point(data = combo_data_plot,
             aes(y=reorder(PP_names, l5), x = l5), size = 1)+
  labs(x = "Overall rewards",y = "Profiles (ordered by mean overall rewards)") +
  theme_light()+theme(legend.position="bottom")
## plot reported in Figure WA10 (left)
plot_scale <- 4.5
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Counterfactual_sim_total_rewards_Psych_profiles.pdf') )

###* Membership probs plot ----
ee_data=ee_data/(niter*Nobs)
colnames(ee_data)=c("Explore", "Exploit", "Inertia")
a=cbind(combo_data_plot, ee_data)

ee_plot_data=a %>% gather(State, Value, Explore,Exploit, Inertia) %>% 
  mutate(ordval=case_when(State=="Explore"~1,
                          State=="Exploit"~2, 
                          TRUE ~ 3)) %>% 
  mutate(PP_names=case_when(
    ID == 1 ~ "Prototypical",
    ID == 2 ~ "Risk-averse",
    ID == 3 ~ "Risk-seeking",
    ID == 4 ~ "Non-analytical",
    ID == 5 ~ "Analytical",
    ID == 6 ~ "Non-intuitive",
    ID == 7 ~ "Intuitive",
    ID == 8 ~ "Satisficer",
    TRUE~"Maximizer"
  ))

ee_plot=ee_plot_data %>% ggplot(aes(x=reorder(PP_names,l5), y=Value, fill=fct_reorder( State, ordval)))+
  geom_bar(stat="identity")+theme_light()+
  labs(y="State membership probability", fill="Proportion of", x="Profiles (ordered by mean overall rewards)")+
  scale_fill_manual(values=c("#C1CDCD", "#668B8B", "#454545"))+
  theme(legend.position = "bottom")
ee_plot + coord_flip()
## plot reported in Figure WA10 (right)
plot_scale <- 4.5
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Counterfactual_sim_membership_prob_Psych_profiles.pdf') )

## Simulation for combo profiles ----
##* Combo profiles with all possible combinations ----
RA=c( quantile(indcen[,2], 0.1), quantile(indcen[,2], 0.5), quantile(indcen[,2], 0.9))
ADM=c( quantile(indcen[,3], 0.1), quantile(indcen[,3], 0.5), quantile(indcen[,3], 0.9))
IDM=c( quantile(indcen[,4], 0.1), quantile(indcen[,4], 0.5), quantile(indcen[,4], 0.9))
MS=c( quantile(indcen[,5], 0.1), quantile(indcen[,5], 0.5), quantile(indcen[,5], 0.9))

Combo_profile=expand.grid(RA, ADM, IDM, MS)
Combo_profile=as.matrix(cbind(rep(1, nrow(Combo_profile)), Combo_profile))

set.seed(0123456789)
TotRewards_data=Combo_data=ee_data=NULL
niter=1000
n_profiles=nrow(Combo_profile)
for (j in 1:n_profiles)
{
  
  ## simulate states
  strue=NULL
  ## Observation eq.
  ysim=Xsim=NULL
  y <- vector("numeric", Nobs)
  X <- vector("numeric", Nobs)
  W_Average_sim= probs=matrix(, ncol=N_arms, nrow=Nobs)
  
  emprobs=matrix(, ncol=N_arms, nrow=Nobs)
  Qij=matrix(, ncol=K, nrow=Nobs)
  
  for (i in 1:niter){
    gamma=matrix(gamma_mean, ncol=nvar)
    
    Delta= t(c(Combo_profile[j,])) %*%gamma
    beta=as.vector(t(Delta)+diag(c(tau_mean))%*%L_Omega_mean%*%as.matrix(rnorm(nvar, 0, 1)))

    lambda1= inv_logit(lambda1_mean)
    lambda2=inv_logit(lambda1_mean+exp(beta[7]))
    rho=inv_logit(beta[8])
    phi=inv_logit(beta[9])
    
    betaM=array(,dim=c(K,D,K))
    for(k in 1:K)
    {betaM[,,k]= matrix(c(beta[((k-1)*(K-1)+1):(k*(K-1))], 0, betaD[((k-1)*(K-1)+1):(k*(K-1))], 0), ncol=D)};
    # transition matrix and states
    sind=gl=vector("numeric", Nobs)
    sind[1]= sample(x = 1:K, size = 1, prob = pi0)
    trprobs=pi0
    
    ## draw a choice from p(y|explore)
    emprobs[1, ]=c(0.333333, 0.333333, 0.333334);
    
    ew=rep(N0, N_arms);
    W_Average=rep(prior,N_arms);
    y[1]=sample(x = 1:N_arms, size = 1, prob = emprobs[1, ])
    X[1]=abs(round(rnorm(1, uncertain_reward[y[1]], sigma_w),0))
    gl[1]=ifelse(X[1]>prior, 0, 1);
    
    for (t in 2:Nobs) {
      
      XD=c(1, gl[t-1]);
      
      Qij[t, ] <- softmax(t(XD)%*%t(betaM[,,sind[t-1]]))
      sind[t] <- sample(x = 1:K, size = 1, prob = Qij[t, ])
      
      ew1=ew[y[t-1]];
      ew[y[t-1]]=rho*ew[y[t-1]]+1;
      W_Average[y[t-1]]=(phi*ew1*W_Average[y[t-1]]+X[t-1])/ew[y[t-1]];
      W_Average_sim[t,]=W_Average
      
      if(sind[t]==1) {
        ## State 1 - exploration;
        emprobs[t, ]=softmax(lambda1*W_Average)
      }else if (sind[t]==2) {
        ## State 2 - exploitation;
        emprobs[t, ]=softmax(lambda2*W_Average);
      }else{
        ## State 3 - inertia;
        emprobs[t, ]=rep(0.000025, N_arms);
        emprobs[t, y[t-1]]=0.99995
      }
      
      y[t]=sample(1:N_arms, size = 1, prob = emprobs[t, ])
      X[t]=abs(round(rnorm(1, uncertain_reward[y[t]], sigma_w),0))
      Xmean=mean(c(prior, X[1:(t-1)]))
      gl[t]=ifelse(X[t]>Xmean,0, 1);
      
    }
    
    ysim=rbind(ysim, y)
    Xsim=rbind(Xsim, X)
    strue=rbind(strue, sind)
  }
  
  tot_rewards=as.vector(rowSums(Xsim))
  totR_mat=cbind(rep(paste("Profile",j,sep="."),length(tot_rewards)), tot_rewards)
  print(j)
  
  ee_mat=c(paste("Profile",j,sep="."), c(table(strue)))
  TotRewards_data=rbind(TotRewards_data, totR_mat)
  Combo_data=rbind(Combo_data, tot_rewards)
  ee_data=rbind(ee_data,  c(table(strue)))
}

##* Combo profiles plot ----
combo_data_small=t(rbind(apply(Combo_data, 1, quantile, probs =c(.25,0.5, 0.75)), 
                         apply(Combo_data, 1, function(x) sd(x)/sqrt(niter))))
colnames(combo_data_small)=c("l025", "l5", "l975", "se_mean")
combo_data_plot=data.frame(ID=1:nrow(combo_data_small), combo_data_small)  

pcombo_data= ggplot(data=combo_data_plot,
                    aes(y=reorder(ID,l5), xmin=l5-1.96*se_mean, xmax=l5+1.96*se_mean))+
  geom_errorbarh(height=0, size=.8) +
  geom_point(data = combo_data_plot,
             aes(y=reorder(ID, l5), x = l5), size = 1)+
  labs(x = "Overall rewards",y = "Profiles (ordered by mean overall rewards)") +
  coord_flip()+
  theme(axis.title.y.right = element_text())+theme_light()+
theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
pcombo_data

## plot reported in Figure WA11
plot_scale <- 4.5
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
save_plot(paste0(PATH_PLOTS, 'Counterfactual_sim_total_rewards_Combo_profiles.pdf') )

### lowest and highest performing profiles
head(combo_data_plot[order(combo_data_plot$l5),])
Combo_profile[1,]
tail(combo_data_plot[order(combo_data_plot$l5),])
Combo_profile[77,]
