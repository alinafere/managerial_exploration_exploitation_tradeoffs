## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021

## Out-of-sample predictions - Cross-sectional validation
## This exemplifies the anlaysis for the EEI/EWA model 
## Change MODEL, INDDIFF, and r flags to run the analysis for all models
## The prediction loop supports parallel computing 
## For computational efficiency, run this code on a machine with 10 cores

## load required packages ----
rm(list=ls())
library(stargazer)
library(loo)
library(rstan)
library(tidyverse)
library(nnet)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

library(doParallel)
registerDoParallel(cores=10) 

## Set paths ---- 
PATH_FUNCTION= "/set/local/path/here" 
PATH_DATA="/set/local/path/here"
PATH_RESULTS="/set/local/path/here"
PATH_PLOTS="/set/local/path/here"

## Source functions ----
source(paste0(PATH_FUNCTION,"/EEtradeoffs_functions.R") )

### Flags ----
## "eei_ewa_mixed" - EEI/EWA proposed model; "discountEV" - EEI/EWA discountEV, "eei_mixed_noEWA" - EEI
## "ee_only_ewa_mixed" - EE/EWA; "eei_stat_ewa" - statEEI/EWA; "ewa_only" - EWA; 
MODEL= "eei_ewa_mixed"
INDDIFF = T # change to F for EEI/EWA  noPsychVars model
r=.9 # set the discount level for discountEV (.5, .7, .9, .95)

if(MODEL=="eei_ewa_mixed"){
  stancode=hmme_eei_ewa_mixed_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="discountEV"){ 
  stancode=hmme_eei_ewa_mixed_discountEV_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="ee_only_ewa_mixed"){ 
  stancode=hmme_ee_only_ewa_mixed_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_mixed_noEWA"){ 
  stancode = hmme_eei_mixed_noEWA_oos
  m = stan_model(model_code = stancode)
}else if (MODEL=="eei_stat_ewa"){ 
  stancode=hmme_eei_stationary_ewa_oos
  m = stan_model(model_code = stancode)
}else{ 
  stancode=ewa_only_oos
  m = stan_model(model_code = stancode)
}

# import dataset
roundsData=read_csv(paste(PATH_DATA, "/businessTask_Study1.csv", sep="") ) 
psychData=read_csv(paste(PATH_DATA, "/psychVars_Study1.csv", sep="") ) 

roundsData=roundsData %>% 
  mutate(Rounds=rounds+1) %>% 
  group_by(userid) %>% 
  mutate(ID = cur_group_id(),
         lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup() %>% 
  arrange(ID, Rounds)

inddif=psychData %>% 
  arrange(user_id) %>% 
  mutate(iota=rep(1, n()), RA=log(crra))%>%
  dplyr::select(iota, RA, SSR, SSE, maximiz, user_id) 

inddifcen=inddif %>% 
  mutate(RAcen=RA-mean(RA), SSRcen=SSR-mean(SSR),
         SSEcen=SSE-mean(SSE), maximizcen=maximiz-mean(maximiz) ) %>% 
  dplyr::select(-c(RA, SSR, SSE, maximiz))

H=length(unique(roundsData$userid))
N_arms= 3
prior=50
D=2
N0=1

if (MODEL=="ee_only_ewa_mixed"){ 
  K=2
  pi0=c(0.99999, 0.00001)
  z=c(1, 2)
  }else{ 
  K=3
  pi0=c(0.99999, 0.000005, 0.000005)
  z=c(1, 2, 3)
}

Nobs=max(roundsData$Rounds)

## Set the number of K-folds, and the number of subjects per fold
Kfold=10
N_in_stratum=9
kfold_ID=tibble(ID=1:H, 
              kfold_id=rep(1:Kfold, N_in_stratum)[1:H] )
roundsData=roundsData %>% left_join(kfold_ID)
nvarHMM=K*(K-1)
nvarWA=3

## Run out-of-sample predictions ----
ptime <- system.time({
  EEI_oos_predictions_across_subjects <- foreach(kfold=icount(Kfold)) %dopar% {
   
est_dataset=roundsData %>% filter(kfold_id != kfold) %>% 
  arrange(usercode, Rounds) %>% 
  group_by(usercode) %>% 
  mutate(est_ID=cur_group_id()) %>% 
  ungroup() %>% 
  arrange(est_ID, Rounds)

  ## filter individual difference vars only for the estimation IDs
  inddif_kfold=inddifcen %>% 
    filter(user_id %in% est_dataset$usercode) %>% 
    arrange(user_id)
  
  if(INDDIFF) {u=as.matrix(inddif_kfold %>% dplyr::select(-user_id))
  }else{ u=as.matrix(inddif_kfold %>% dplyr::select(iota)) }
  
  ndem=ncol(u)

pred_dataset =  roundsData %>% filter(kfold_id == kfold) %>% 
  arrange(usercode, Rounds) %>% 
  group_by(usercode) %>% 
  mutate(pred_ID=cur_group_id()) %>% 
  ungroup()

stan.data = list(
  N=length(est_dataset$picks),  # number of observations
  H=length(unique(est_dataset$est_ID)), # number of individuals
  K=K,                               # number of hidden states
  nvar_ind=3,
  N_arms=N_arms,    # number of possible choices
  T=pull(est_dataset, Rounds), # vector for the time series per individual
  lastT=pull(est_dataset, lastT),  # vector for the time series per individual
  ID=pull(est_dataset, est_ID),  # vector of individual index
  y=pull(est_dataset, picks),
  prior=rep(prior, N_arms),
  X=pull(est_dataset, results),
  D=2,
  pi0=pi0,
  N0=1,
  z=z,
  u=u,
  ndem=ndem,
  r=r)

EEI_ooskfold = stan(model_code = stancode, data = stan.data,
                                verbose = TRUE, chains = 1,
                                seed = 123456, iter = 4, warmup = 1,
                                control = list(adapt_delta=0.99, max_treedepth=15))

  list(Kfold_id=kfold,
     EEI_oos_kfold = EEI_ooskfold)
}
    
})[3]

ptime

setwd(PATH_RESULTS)
save.image(file=paste0(MODEL, "_", DATA,"_oos_preds_across_subjects.RData"))

### Compute out-of-sample predictions -----
set.seed(123456)
    Niter=3
    Zpred_overall=Ypred_overall=NULL
    hr=mse=matrix( , nrow=Kfold, ncol=Niter)
    pred_data_with_oos_full=tibble()

for (kfold in 1:Kfold) {
      
      est_dataset=roundsData %>% filter(kfold_id != kfold) %>% 
        arrange(usercode, Rounds) %>% 
        group_by(usercode) %>% 
        mutate(est_ID=cur_group_id()) %>% 
        ungroup() %>% 
        arrange(est_ID, Rounds)
      
      pred_dataset =  roundsData %>% filter(kfold_id == kfold) %>% 
        arrange(usercode, Rounds) %>% 
        group_by(usercode) %>% 
        mutate(pred_ID=cur_group_id()) %>% 
        ungroup()
      
      
      stfit=sflist2stanfit(EEI_oos_predictions_across_subjects[[kfold]][2])
      pred_df=pred_dataset
      est_df=est_dataset
      inddifFull=inddifcen
      
      ## change function when changing the model, mind the function inputs
      ## functions necessary for all models are available in EEtradeoffs_functions.R
      OOS_k=out_of_sample_predictions_across_subjects(stfit = sflist2stanfit(EEI_oos_predictions_across_subjects[[kfold]][2]), 
                                                      pred_df = pred_dataset, 
                                                     est_df=est_dataset, inddifFull=inddifcen)

      pred_data_with_oos_full=pred_data_with_oos_full %>% 
        bind_rows(OOS_k[[4]])
      hr[kfold, ]= OOS_k[[1]] 
      mse[kfold, ]=OOS_k[[2]]
    }
    

colnames(hr)=paste0("Iter", 1:Niter)
rownames(hr)=paste0("Kfold", 1:Kfold)
colnames(mse)=paste0("Iter", 1:Niter)
rownames(mse)=paste0("Kfold", 1:Kfold)
hr_long=as_tibble(hr) %>% bind_cols(Kfold=paste0("fold",1:10) ) %>% 
  pivot_longer(-Kfold, names_to="Iter", values_to="hr")
mse_long=as_tibble(mse) %>% bind_cols(Kfold=paste0("fold",1:10)) %>% 
  pivot_longer(-Kfold, names_to="Iter", values_to="mse")

OOS_measures= hr_long %>% 
  bind_cols(mse_long %>% dplyr::select(mse)) %>% 
  mutate(Model=rep(MODEL, n())) 
OOS_measures %>% summarise(mean(hr), mean(mse))

setwd(paste0(PATH_RESULTS, "/OOS_hrmse_across"))
write_csv(OOS_measures, paste0("OOS_hrmse_measures_", MODEL, ".csv")) 

##* compute HR MSE across all models ----
## reported in Tables 5 (right) and WA5 (right)
OOS_hrmse_across <- list.files(path=paste0(PATH_RESULTS, "/OOS_hrmse_across"), full.names = TRUE) %>%
  lapply(read.delim, sep=",") %>%
  bind_rows
OOS_hrmse_across = as_tibble(OOS_hrmse_across)

hrmse_overall=OOS_hrmse_across %>% 
  group_by(Model) %>% 
  summarise( mse=round(mean(mse), 3), hr=round(mean(hr), 3)*100) %>% 
  ungroup()
stargazer(hrmse_overall, summary=F, align=F)

##* Switching behavior ----
## save dataset for the EEI/EWA model 
pred_data_oos_switch=pred_data_with_oos_full %>% 
  dplyr::select(userid, usercode, picks, Rounds, kfold_id, paste0('ypred_it', 1:Niter)) %>% 
  mutate(Model= MODEL)
setwd(paste0(PATH_RESULTS, "/OOS_switch_across"))
write_csv(pred_data_oos_switch, paste0("OOS_across_switching_data_", MODEL, ".csv"))

## import datasets for all models
OOS_switch_over_models <- list.files(path=paste(PATH_RESULTS, "/OOS_switch",  sep=""), full.names = TRUE) %>%
  lapply(read.delim, sep=",") %>%
  bind_rows
OOS_switch_over_models= as_tibble(OOS_switch_over_models)

##** compute switching behavior ---- 
ypred=OOS_switch_over_models %>% 
  dplyr::select(starts_with("ypred")) 
lag_ypred=ypred %>% 
  mutate_all(lag_yrep)
switch_ypred=ifelse(ypred==lag_ypred, 0, 1)
Niter=1000
colnames(switch_ypred)=paste0("ypred_it", 1:Niter)

Oos_switch_across=OOS_switch_over_models%>% 
  mutate(lag_picks=lag(picks, 1, 0)) %>% 
  mutate(obs_switches=ifelse(picks==lag_picks, 0, 1)) %>% 
  dplyr::select(-starts_with("ypred")) %>% 
  bind_cols(as_tibble(switch_ypred)) %>% 
  filter(Rounds!=1) %>% 
  group_by(userid, Model) %>% 
  summarise_at(vars(obs_switches:paste0("ypred_it", Niter)), mean) %>% 
  pivot_longer(-c(Model, userid, obs_switches), names_to="iter", values_to = "ppc_switch") 

## mae per model, reported in Tables 5 (right) and WA5 (right)
mae_across=Oos_switch_across %>% 
  group_by(userid) %>% 
  summarise(obs_switch_user=mean(obs_switches)) %>% 
  mutate(switch_decile = ntile(obs_switch_user, 10)) %>% 
  ungroup() %>% 
  full_join(Oos_switch_across) %>% 
  mutate(MAE_switch=abs(obs_switches-ppc_switch))

mae_across %>% group_by(switch_decile) %>% 
  summarise(count=n()/(Niter*10), minS=min(obs_switches), meanS=mean(obs_switches), 
            maxS=max(obs_switches))

mae_overall=mae_across %>%
  group_by(Model) %>% 
  summarise(mae=round(mean(MAE_switch), 3) ) %>% 
  ungroup()
stargazer(mae_overall, summary=F,align=F)

##** Plot MAE over round deciles ---- 
## Figures 14 and WA3 (right)
mae_across$Model=factor(mae_across$Model, 
                                    levels = c("EEI", "EWA", "EE/EWA", "statEEI/EWA", "EEI/EWA no PsychVars", 
                                               "EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", 
                                               "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA"))

plot_switch_across_basicModels=mae_across %>% 
  filter(Model %in% c("EEI", "EWA", "EEI/EWA")) %>% 
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual( values=c("#668B8B", "#C1CDCD", "darkblue"))+
  labs(y ='Percentage switches')+
  theme_light()+theme(legend.position="bottom")
plot_switch_across_basicModels

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
setwd(PATH_PLOTS)
save_plot('plot_switch_decile_OOS_across_basicModels.pdf')


plot_switch_across_Components=mae_across %>% 
  filter(Model %in% c("statEEI/EWA", "EE/EWA", "EEI/EWA no PsychVars","EEI/EWA") ) %>%
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=7)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual(values=c( "#C1CDCD","#668B8B", "#8673D0", "darkblue"))+ 
  labs(y = 'Percentage switches')+ # 'Mean absolute error') +
  theme_light()+theme(legend.position="bottom")


plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
setwd(PATH_PLOTS)
save_plot('plot_switch_decile_OOS_across_Components.pdf')


plot_switch_across_discountEV=mae_across %>% 
  filter(Model %in% c("EEI/EWA discount EV (.5)", "EEI/EWA discount EV (.7)", "EEI/EWA discount EV (.9)", "EEI/EWA discount EV (.95)", "EEI/EWA")) %>%
  ggplot(aes(x = switch_decile, y = ppc_switch*100, color=Model)) +
  stat_summary(fun.data = mean_cl_boot, position=position_dodge(width=.5)) +
  stat_summary(aes(x = switch_decile, y=obs_switches*100),fun.data = mean_cl_boot, color="black", shape=15)+
  scale_x_continuous(name="Deciles (observed percentage switches)", breaks=seq(1, 10, 1))+
  scale_color_manual(values=c("darkgreen", "#668B8B", "#C1CDCD", "#8673D0", "darkblue"), 
                     labels=c("Discount .5", "Discount .7", "Discount .9", "Discount .95", "EEI/EWA"))+
  labs(y = 'Percentage switches')+ #'Mean absolute error') +
  theme_light()+theme(legend.position="bottom")
plot_switch_across_discountEV

plot_scale <- 4
plot_aspect <- 1.5
save_plot <- purrr::partial(ggsave, width = plot_aspect * plot_scale, height = 1 * plot_scale)
setwd(PATH_PLOTS)
save_plot('plot_switch_OOS_across_discountEV.pdf')
