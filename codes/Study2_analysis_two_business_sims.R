## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021
# Analysis for Study 2 (Web Appendix WA1) - two business simulations

## Load required packages ----
rm(list=ls())
library(rstan)
library(tidyverse)
library(magrittr)
library(Hmisc)
library(stargazer)
library(rstan)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

PATH_FUNCTION= "/set/your/paths/here"
PATH_DATA= "/set/your/paths/here"
PATH_RESULTS= "/set/your/paths/here"

## Source functions ----
source(paste(PATH_FUNCTION,"/EEtradeoffs_functions.R", sep="") ) 

## FLAGS ----
MODEL="eei_ewa_mixed_infPrior" ## eei_ewa_mixed - EEI/EWA model; 
## eei_ewa_mixed_infPrior - EEI/EWA with informative priors for Bsim2
DATA=="Bsim2" ## for the second business simualtion
## change to "Bsim1" for the first business simulation

if(MODEL=="eei_ewa_mixed"){
  stancode=hmme_eei_ewa_mixed
  m = stan_model(model_code = hmme_eei_ewa_mixed)
}else { # with informative priors
  stancode=hmme_eei_ewa_mixed_infPriors
  m = stan_model(model_code = hmme_eei_ewa_mixed_infPriors)
}

## LOAD DATA ----
roundsData_2sims=read_csv(paste(PATH_DATA, "/roundsData_xtreme2.csv",  sep=""))  
psychVars=read_csv(paste(PATH_DATA, "/psychVars_xtreme2.csv",  sep=""))

roundsData_2sims %<>% 
  ## This usercode has no business simulation data 
  ## due to recording error on our website
  filter(usercode!="2RM6E4RVD") %>% 
  arrange(usercode, Business_sim, Rounds)%>% 
  group_by(usercode) %>% 
  mutate(ID = cur_group_id()) %>% 
  ungroup()  
  
psychVars %<>% 
  mutate(usercode=gsub("X", "", usercode) ) %>% 
  filter(usercode!="2RM6E4RVD")%>% 
  arrange(usercode) %>% 
  group_by(usercode) %>% 
  mutate(ID = cur_group_id())  %>% 
  ungroup()

#* filter inddif vars----
inddif=psychVars %>% 
  mutate(iota=rep(1, n()), RA=log(crra))%>%
  dplyr::select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (i in 2:ncol(indcen))
  indcen[,i]=indcen[ ,i]-mean(indcen[ ,i])

u=indcen
ndem=ncol(u)

## RUN THE MODEL----
## filter dataset for each business sim 
if (DATA=="Bsim1"){
roundsData_bsim = roundsData_2sims %>%  
  filter(Business_sim=="business_sim_1") %>% 
  group_by(usercode) %>% 
  mutate(lastT=ifelse(row_number()==n(), 1,0)) %>% 
  ungroup()
}else{
  roundsData_bsim = roundsData_2sims %>%  
    filter(Business_sim=="business_sim_2") %>% 
    group_by(usercode) %>% 
    mutate(lastT=ifelse(row_number()==n(), 1,0)) %>% 
    ungroup()
}

  pi0=c(0.99999, 0.000005, 0.000005)
  z=c(1, 2, 3)
  K=3

prior=50
N_arms=3

## informative priors for bsim2, based on the estimates from bsim1 
gamma_pmean=read_csv(paste0(PATH_DATA, "/gamma_prior_mean.csv"))
gamma_psd=read_csv(paste0(PATH_DATA, "/gamma_prior_sd.csv"))
betaD_pmean=read_csv(paste0(PATH_DATA, "/betaD_prior_mean.csv"))
betaD_psd=read_csv(paste0(PATH_DATA, "/betaD_prior_sd.csv"))

lambda_prior=c(-2.41, 0.12)

gamma_prior_mean=round(gamma_pmean$prior_mean, 2)
gamma_prior_sd=diag(round(gamma_psd$prior_sd, 2))
betaD_prior_mean=round(betaD_pmean$prior_mean, 2)
betaD_prior_sd=diag(round(betaD_psd$prior_sd, 2))
D=2


### Stan dataset -----
stan.data = list(
  N=nrow(roundsData_bsim),                   # number of observations
  H=length(unique(roundsData_bsim$ID)),      # number of individuals
  K=K,                                       # number of hidden states
  N_arms=N_arms,                             # number of possible choices 
  lastT=pull(roundsData_bsim, lastT),        # vector for the time series per individual
  ID=   pull(roundsData_bsim, ID),           # vector of individual index
  y=    pull(roundsData_bsim, picks),
  X=    pull(roundsData_bsim, results),
  T=    pull(roundsData_bsim, Rounds),
  prior=rep(prior, N_arms),
  D=D,
  pi0=pi0,
  N0=1,
  z=z,
  u=u,
  ndem=ncol(u),
  dim_gamma_prior=(((K-1)*K+3)*ncol(u)),
  nvar_ind=((K-1)*K+3),
  nvar_baseline=(K-1)*K,
  nvar_cov=K*(K-1)*(D-1),
  gamma_prior_mean=gamma_prior_mean,
  gamma_prior_sd=gamma_prior_sd,
  lambda_prior_mean=lambda_prior[1],
  lambda_prior_sd=lambda_prior[2],
  betaD_prior_mean=betaD_prior_mean,
  betaD_prior_sd=betaD_prior_sd
)


if (MODEL=="eei_ewa_mixed" ){
## Run model for Bsim1----
EEI_EWA_Study2_bsim1 <- stan(model_code = stancode, data = stan.data,
                                        verbose = TRUE, chains = 2,
                                        seed = 123456, iter = 4000, warmup=3000, control = list(adapt_delta=0.99, max_treedepth=15))

## Results----
setwd(PATH_RESULTS)
save(EEI_EWA_Study2_bsim1, file="EEI_EWA_Study2_bsim1.RData")
}else{
## Run model for Bsim2 ----
EEI_EWA_Study2_bsim2_inftauPrior <- stan(model_code = stancode, data = stan.data,
                      verbose = TRUE, chains = 2,
                      seed = 123456, iter = 4000, warmup=3000, control = list(adapt_delta=0.99, max_treedepth=15))

## Results----
setwd(PATH_RESULTS)
save(EEI_EWA_Study2_bsim2_inftauPrior, file="EEI_EWA_Study2_bsim2_inftauPrior.RData")
}
