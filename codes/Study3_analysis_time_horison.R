## Replication code for "Understanding Managers' Trade-offs between Exploration and Exploitation"
# Author: Alina Ferecatu and Arnaud De Bruyn
# Date: April 2021
# Analysis for Study 3  (Web Appendix WA1) - four time horisons

## Load required packages ----
rm(list=ls())
library(rstan)
library(tidyverse)
library(magrittr)
library(Hmisc)
library(stargazer)

rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

## Set paths ----
PATH_FUNCTION="/set/your/path/here"
PATH_DATA= "/set/your/paths/here"
PATH_RESULTS="/set/your/path/here"

## Source functions ----
source(paste(PATH_FUNCTION,"/EEtradeoffs_functions.R", sep="") ) 
m = stan_model(model_code = hmme_eei_ewa_mixed_oos)

## Load data ----
roundsData_xtreme3=read_csv(paste(PATH_DATA, "/roundsData_xtreme3.csv",  sep=""))  
psychVars=read_csv(paste(PATH_DATA, "/psychVars_xtreme3.csv",  sep=""))

## data cleaning step, removing the character X which was poorly encoded
roundsData_xtreme3 %<>% 
  mutate(usercode=gsub("X", "", usercode) )
psychVars %<>% 
  mutate(usercode=gsub("X", "", usercode) )
roundsData_xtreme3 %<>% arrange(usercode, Rounds) 
psychVars %<>% arrange(usercode)

roundsData_xtreme3=roundsData_xtreme3 %>% 
  filter(usercode %in% psychVars$usercode)

psychVars=psychVars %>% 
  filter(usercode %in% roundsData_xtreme3$usercode)

roundsData = roundsData_xtreme3 %>%  
  group_by(usercode) %>% 
  mutate(condition=rep(last(Rounds), n()),
         lastT=ifelse(row_number()==n(), 1,0),
         ## there were six data points with errors recording time spent (negative).
         ## replaced here with mean time spent
         time_spent=if_else(time_spent<0, mean(time_spent), time_spent)) %>% 
  ungroup()

##############################################
## Create condition-level dataset ----
#* change conditions to 20, 50, 100, or 200 rounds at line 58
roundsData_condition=roundsData %>% 
  ## change condition here
  filter(condition==200) %>%
  arrange(usercode, Rounds) %>% 
  group_by(usercode) %>% 
  mutate(ID = cur_group_id()) %>% 
  ungroup()

psychVars_condition=psychVars %>% 
  filter(usercode %in% roundsData_condition$usercode) %>% 
  arrange(usercode) %>% 
  left_join(roundsData_condition %>% filter(lastT==1) %>% 
              dplyr::select(usercode, ID))

H=length(unique(roundsData_condition$usercode))
N_arms= 3
prior=50

#* filter inddif vars----
inddif=psychVars_condition %>% 
  mutate(iota=rep(1, n()), RA=log(crra))%>%
  select(iota, RA, SSR, SSE, maximiz)

indcen=as.matrix(inddif)
for (i in 2:ncol(indcen))
  indcen[,i]=indcen[ ,i]-mean(indcen[ ,i])

u=indcen
ndem=ncol(u)

pi0=c(0.99999, 0.000005, 0.000005)
z=c(1, 2, 3)
K=3

### Stan dataset -----
stan.data = list(
  N=nrow(roundsData_condition), # number of observations
  H=H,             # number of individuals
  K=K,             # number of hidden states
  N_arms=N_arms,   # number of possible choices            
  lastT=pull(roundsData_condition, lastT),  # vector for the time series per individual
  ID=pull(roundsData_condition, ID),     # vector of individual index
  y=pull(roundsData_condition, picks),
  prior=rep(prior, N_arms),
  X=pull(roundsData_condition, results),
  T=pull(roundsData_condition, Rounds),
  D=2,
  pi0=pi0,
  N0=1,
  z=z,
  u=u,
  ndem=ncol(u)
)

## Run the model ----
EEI_EWA_Study3_c200<- stan(model_code = hmme_eei_ewa_mixed, data = stan.data,
                      verbose = TRUE, chains = 2,
                      seed = 123456, iter =4000, warmup=3000, 
                      control = list(adapt_delta=0.99, max_treedepth=15))

setwd(PATH_RESULTS)
save(EEI_EWA_Study3_c200, file="EEI_EWA_Study3_c200.RData")
